<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Minicart Fixed</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 4px;
            background: #e9ecef;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Test Minicart Fixed</h1>
        <p>Trang này để test minicart đã được sửa.</p>
        
        <div class="status" id="status">
            Đang kiểm tra minicart...
        </div>
        
        <button class="test-button" onclick="testMinicart()">Test Minicart</button>
        <button class="test-button" onclick="checkElements()">Kiểm tra Elements</button>
        <button class="test-button" onclick="forceLoadMinicart()">Force Load Minicart</button>
        <button class="test-button" onclick="runDebug()">Run Debug</button>
        
        <div data-include="header"></div>
        <div data-include="minicart"></div>
        
        <div class="debug-info" id="debug-info">
            Debug info will appear here...
        </div>
    </div>

    <script src="./include.js"></script>
    <script src="./assets/local-fixes.js"></script>
    <script src="./debug-minicart.js"></script>
    
    <script>
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function updateDebugInfo(message) {
            const debugInfo = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
        
        function checkElements() {
            const mini = document.querySelector('.mini-cart');
            const backdrop = document.querySelector('.mini-cart__backdrop');
            const toggleBtn = document.querySelector('[data-toggle-bag]');
            
            let message = `Elements check:\n`;
            message += `- Mini-cart: ${mini ? '✓ Found' : '✗ Not found'}\n`;
            message += `- Backdrop: ${backdrop ? '✓ Found' : '✗ Not found'}\n`;
            message += `- Toggle button: ${toggleBtn ? '✓ Found' : '✗ Not found'}`;
            
            updateStatus(message, mini && backdrop && toggleBtn ? 'success' : 'error');
            updateDebugInfo(message);
        }
        
        function testMinicart() {
            if (window.miniCartToggle) {
                window.miniCartToggle.open();
                updateStatus('Minicart opened!', 'success');
                updateDebugInfo('Minicart opened successfully');
            } else {
                updateStatus('Minicart toggle not available', 'error');
                updateDebugInfo('Minicart toggle not available');
            }
        }
        
        function forceLoadMinicart() {
            const minicartHook = document.querySelector('[data-include="minicart"]');
            if (minicartHook && window.loadPartial) {
                window.loadPartial(minicartHook, './partials/minicart.html').then(function() {
                    document.dispatchEvent(new Event('minicartLoaded'));
                    updateStatus('Minicart force loaded!', 'success');
                    updateDebugInfo('Minicart force loaded successfully');
                    setTimeout(checkElements, 500);
                });
            } else {
                updateStatus('Cannot force load minicart', 'error');
                updateDebugInfo('Cannot force load minicart');
            }
        }
        
        function runDebug() {
            if (window.debugMinicart) {
                updateDebugInfo('Running debug functions...');
                window.debugMinicart.checkElements();
                window.debugMinicart.checkScripts();
                window.debugMinicart.checkMinicartState();
            } else {
                updateDebugInfo('Debug functions not available');
            }
        }
        
        // Listen for minicart loaded event
        document.addEventListener('minicartLoaded', function() {
            updateStatus('Minicart loaded successfully!', 'success');
            updateDebugInfo('Minicart loaded event triggered');
            setTimeout(checkElements, 500);
        });
        
        // Check elements after page loads
        setTimeout(checkElements, 1000);
        setTimeout(checkElements, 3000);
        setTimeout(checkElements, 5000);
        
        // Log to debug info
        updateDebugInfo('Page loaded, scripts initialized');
    </script>
</body>
</html>
